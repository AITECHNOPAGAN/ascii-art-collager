<!-- 048d63d1-7f75-4b0d-a500-e8bd5cfba0a8 7812b7b5-9afb-4b45-875f-7c1fd65e7b44 -->
# Enhanced Layer Editing System

## Overview

Transform the current layer system to support two distinct layer types with full editing capabilities: ASCII/Character Lattice layers with per-character state management and Image layers with per-pixel editing.

## Core Changes

### 1. Type System Refactor (`src/types/index.ts`)

- Replace current `ContentType` with proper layer types: `'ascii'` and `'image'`
- Create `CharacterCell` interface for lattice: `{ char: string, textColor: string, bgColor: string, alpha: number }`
- Create `AsciiLattice` interface: `{ width: number, height: number, cells: CharacterCell[][] }`
- Update `Layer` interface to use discriminated union pattern:
- ASCII layers: contain `lattice: AsciiLattice`, `resolution: number`, `originalImage?: string` (for re-conversion)
- Image layers: contain `imageData: string`, `editedPixels?: string` (data URL, not ImageData)
- Create `ProjectState` interface for full serialization: includes all layers, canvas settings, metadata
- All data structures must be JSON-serializable (no ImageData, HTMLImageElement, etc.)

### 2. ASCII Lattice System

#### Image to ASCII Conversion (`src/utils/imageToAscii.ts`)

- Update `convertImageToAscii()` to accept resolution parameter
- Return `AsciiLattice` structure instead of HTML string
- Store per-character color data (text color, bg color, alpha) in lattice cells
- Support color preservation when pasting colored ASCII art

#### ASCII Layer Rendering (`src/features/canvas/AsciiLayer.tsx`)

- Convert from rendering HTML string to rendering lattice structure
- Render each character cell with individual text/bg colors and alpha
- Use CSS Grid for proper character alignment

### 3. Layer Store Updates (`src/stores/LayerStore.ts`)

Add methods for ASCII lattice editing:

- `updateLatticeCell(layerId, x, y, updates: Partial<CharacterCell>)`
- `eraseLatticeCell(layerId, x, y)` 
- `setLatticeResolution(layerId, resolution)` - regenerate lattice at new resolution
- `importColoredAscii(text: string)` - parse pasted colored ASCII (preserve ANSI/HTML colors)

Add methods for image editing:

- `updateImagePixels(layerId, pixels: ImageData, region: {x, y, width, height})`
- `getImagePixelData(layerId)` - get canvas pixel data for editing

### 4. Editing Tools System

Create new editing infrastructure:

- `src/stores/EditingStore.ts` - manages active tool, brush settings, tool state
- Tools: `'select' | 'draw' | 'erase' | 'color-picker'`
- Brush settings: `radius: number`, `currentChar: string`, `currentTextColor: string`, `currentBgColor: string`

- `src/features/canvas/EditableAsciiLayer.tsx` - ASCII layer with editing overlay
- Mouse event handlers for drawing/erasing on lattice
- Visual brush preview cursor
- Apply brush radius to affect N×N character cells

- `src/features/canvas/EditableImageLayer.tsx` - Image layer with editing overlay  
- Canvas-based pixel editing
- Brush with circular pixel area
- Paint/erase operations on pixel data

### 5. UI Components

#### Resolution Control (`src/features/layers/LayerControls.tsx`)

- Add resolution slider per ASCII layer (e.g., 50-200 characters width)
- When resolution changes, regenerate lattice from original image
- Show current lattice dimensions (width × height)

#### Editing Toolbar (new: `src/features/editing/EditingToolbar.tsx`)

- Tool selector: Select, Draw, Erase, Color Picker
- Brush radius slider
- Character selector (for ASCII layers)
- Color pickers (text color, bg color)
- Alpha/transparency slider

#### Layer Type Selection

- Update layer creation to specify type upfront (ASCII vs Image)
- Remove old contentType radio buttons, replace with layer type

### 6. Persistence & Serialization System

#### Project State Management (new: `src/utils/projectSerializer.ts`)

- `serializeProject(stores): ProjectState` - serialize all stores to JSON
- `deserializeProject(json): ProjectState` - parse and validate JSON
- `saveToLocalStorage()` - auto-save current state
- `loadFromLocalStorage()` - restore last session
- `downloadProjectFile()` - export as .json file
- `loadProjectFile(file)` - import from .json file

#### Store Integration (`src/stores/LayerStore.ts`, `src/stores/RootStore.ts`)

- `loadProjectState(state: ProjectState)` - hydrate stores from saved state
- `toJSON()` methods in stores for clean serialization
- Handle image data URLs in layer serialization

#### UI Components (new: `src/features/project/ProjectControls.tsx`)

- Save/Load buttons in UI
- Auto-save indicator
- "New Project" (with unsaved changes warning)
- File import/export

### 7. Export Updates (`src/utils/htmlExporter.ts`)

- Export ASCII lattices as proper HTML with inline styles per character
- Maintain color information in exported HTML
- Support transparency export

## Key Files to Modify

- `src/types/index.ts` - Type definitions
- `src/stores/LayerStore.ts` - Layer management
- `src/stores/EditingStore.ts` - NEW: Editing tools state
- `src/utils/imageToAscii.ts` - Lattice generation
- `src/features/canvas/AsciiLayer.tsx` - Lattice rendering
- `src/features/canvas/EditableAsciiLayer.tsx` - NEW: ASCII editing
- `src/features/canvas/EditableImageLayer.tsx` - NEW: Image editing
- `src/features/editing/EditingToolbar.tsx` - NEW: Tool UI
- `src/features/layers/LayerControls.tsx` - Resolution controls
- `src/utils/htmlExporter.ts` - Export with colors

## Implementation Notes

- Keep architecture flexible for future tools (fill, shapes, etc.)
- Use proper data structures (2D arrays) for efficient lattice access
- Maintain undo/redo capability consideration in store design
- Preserve existing parallax and positioning features

### To-dos

- [ ] Refactor type system to support ASCII lattice and discriminated layer union
- [ ] Update imageToAscii to generate lattice structure with per-character colors
- [ ] Update AsciiLayer to render from lattice structure with CSS Grid
- [ ] Add lattice and image editing methods to LayerStore
- [ ] Create EditingStore for tool state management
- [ ] Create EditableAsciiLayer with mouse-based lattice editing
- [ ] Create EditableImageLayer with canvas-based pixel editing
- [ ] Create EditingToolbar UI component with tools and brush controls
- [ ] Add per-layer resolution control to LayerControls
- [ ] Update HTML exporter to handle lattice structure with colors
- [ ] Integrate editing system into canvas and update App.tsx